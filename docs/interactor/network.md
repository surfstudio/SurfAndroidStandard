# Работа с Сервером

[TOC]

Работа с сервером обычно происходит с помощью библиотек retrofit2, okhttp, gson, rxjava.

Для работы с сетью предусмотрены модули:
 * [network](../../network/README.md)
 * [Gson-конвертер](../../converter-gson/README.md)

При работе с сервером возникает необхдимость добавлять те или иные параметры
в запрос. Для этих целей хорошо подходит сущности типа `Interceptor`. Такие
сущности передаются в билдер OkHttp-клента.

Также удобно [логгировать][log] ответы сервера, а также ошибки парсинга на удаленный сервер
с целью быстрого нахождения ошибок. **Не следует логгировать пользовательские
данные**.

### Обработка ошибок

Обработка большинства ошибок происходит [на уровне Presenter'а][handle_errors_on_presenter].

Если на сервере существует механизм ошибок, когда не с 200-м кодом
приходит еще и тело ошибки, то такие сообщения следует приводить к специфичному
исключению. Эти операции следует производить на уровне [`CallAdapter`'а][call]

Ошибки парсинга Json (JsonSyntaxException) следует конвертировать в некоторую
кастомную ошибку. Этим занимается [`Converter`][gson].

###### Открытие экранов по спец ошибкам

В случае если возникает необходимость открыть экран прямо из слоя Interactor,
например, когда у пользователя устарел токен и необходимо перекинуть его на экран
авторизации, необходимо использовать глобальный навигатор, поставляемый модулем
[core-ui](../../core-ui/README.md).
Это необходимо,  чтобы не тащить данную логику на ui.

### Кеширование данных

Хорошей практикой является кеширование загруженных данных. Например,
результатов поиска, пользовательского профиля, содержимого некого экрана.
Это необходимо, чтобы пользователь мог видеть уже загруженный им контент
без дополнительной перезагрузки.

Кешировать данные можно по-разному. Самые известные подходы - это:

- [**простой кеш**][simple_cache] - например в виде Url-кэша.В этом случае ответы сервера сохраняются
в файловую систему. Причем они сохраняются в соответствии с теми url, по
которым были получены.

    *Преимущества*:
     - быстрый

- [**объектное хранилище**][file_cache] - кеширует объекты в файловую систему.
   В нашей реализации лежит в основе простого кеша.

   *Преимущества*:
   - В отличие от простого кеша, можно сохранить любые данные. А не только
   json по url.

- **база данных** - если нужен только кеш - не самое лучшее решение.
   БД созданы для более сложных задач.

При использовании кеша встает вопрос о том, как и когда его обновлять. С решением
этой проблемы может помочь механизм [etag][etag], а также [гибридные
запросы][hybrid].

### Маппинг ответов сервера

Хорошей практикой явлется разделение серверной модели данных (доиенной модели)
и соответстующей на клиенте. Это обусловлено тем, что не все, что есть на сервере
и что он отдает, необходимо и используется на клиенте. Например, сервер на несколько запросов
отдает краткую информацию о пользователе, полную информацию и, допустим,
информацию о пользователе с адресом. Все эти три сущности на самом деле
являются одним и тем же - пользователем, и на клиенте нет смысла заводить
все три.

Доменная область на клиенте(в приложении) должна отвечать в первую очередь бизнес-логике
приложения.

Исходя из этих соображений, возникает необходимость преобразовавыть ответы сервера
в модели на клиенте.

В наших приложениях приняты следующие договоренности - классы,
которые используются:

- для парсинга ответа должны быть с суффиксом `Response` и расширять интерфейс
`BaseResponse`

- для формирования запроса должны быть с суффиксом `Request`

- для парсинга вложенных Json объектов должны быть с суффиксом `Obj`

Маппинг серверных ответов происходит в репозитории `Repository` с помощью
[методов специальных методов, утилит или
операторов(так как используем Rx)][mapping].

### Тесты API

Тестирование API - важный процесс, который помогает избежать траты времени, на
поиск багов сервера. Пожтому ему стоит уделять внимание.

Следует покрывать тестами все методы сервера, чтобы понимать состояние сервера.


[log]: ../common/logging.md
[gson]: ../../converter-gson/README.md
[call]: ../../network/README.md
[simple_cache]: ../../network/docs/usage.md
[etag]: ../../network/docs/etag.md
[hybrid]: ../../network/docs/hybrid.md
[handle_errors_on_presenter]: ../ui/presenter.md
[file_cache]: ../../filestorage/README.md
[mapping]: ../../network/docs/usage.md
